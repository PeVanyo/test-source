name: Send Create Webhook to Infrastructure

on:
  pull_request:
    types:
      - opened

jobs:
  send-webhook:
    runs-on: ubuntu-latest

    steps:
      - name: Check PR status every 20 seconds for 2 minutes
        id: check_pr
        run: |
          for i in {1..6}; do
            echo "Making API call to check PR status..."
            api_response=$(curl -s -H "Authorization: token ${{ secrets.test_PAT }}" \
                                  "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}")
            echo "API Response: $api_response"
            pr_status=$(echo "$api_response" | jq -r '.state')
            echo "Check #$i: PR status is $pr_status"
            if [ "$pr_status" = "closed" ]; then
              echo "============================================================================="
              echo "PR is closed. Exiting workflow."
              echo "::set-output name=should_exit::true"
              exit 0
            fi
            sleep 20
          done
          echo "::set-output name=should_exit::false"


      - name: Send Webhook to Infrastructure Repository
        if: steps.check_pr.outputs.should_exit != 'true'
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          echo "============================================================================="
          echo "The PR is still open, proceeding with webhook."

      - name: Add PR comment
        run: |
          echo "============================================================================="
          echo "Adding PR comment..."
